<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JPM Prep v20.38 (Layout Engine Fix)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        jpm: { primary: '#0f4c81', dark: '#1e3a5f', light: '#e0f2fe', accent: '#00a1de' },
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9' }
                    },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' },
                    height: { 'dvh': '100dvh' },
                    animation: { 'blob': 'blob 7s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-attachment: fixed;
            overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        .dark body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scroll-touch { -webkit-overflow-scrolling: touch; }
        .stable-scroll { scrollbar-gutter: stable; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(200, 200, 200, 0.3);
        }
        .dark .glass-nav { background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255, 255, 255, 0.1); }

        /* FIXED CARD SCENE */
        .card-scene { perspective: 1000px; width: 100%; height: 100%; position: relative; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-face { 
            position: absolute; inset: 0; 
            backface-visibility: hidden; -webkit-backface-visibility: hidden; 
            border-radius: 1.5rem; display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); 
        }
        
        .card-content { flex-grow: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        
        .card-face.front { background: rgba(255,255,255,0.95); transform: rotateY(0deg); border: 1px solid rgba(255,255,255,0.5); }
        .dark .card-face.front { background: rgba(30,41,59,0.95); border-color: rgba(255,255,255,0.1); }
        .card-face.back { background: #f0fdf4; border: 2px solid #86efac; transform: rotateY(180deg); }
        .dark .card-face.back { background: #064e3b; border-color: #059669; }
        .is-flipped { transform: rotateY(180deg); }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }
        .recording-active { animation: pulse-red 1.5s infinite; background-color: #ef4444; color: white; border-color: #b91c1c; }
        
        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Drawer Overlay Animation */
        .drawer-overlay { transition: opacity 0.3s ease-out, visibility 0.3s; }
        .drawer-content { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- UTILS ---
        const parseCSV = (text) => {
            if (!text || typeof text !== 'string') return [];
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); 
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            const delimiter = lines[0].includes('|') ? '|' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            
            // Simple robust parser
            return lines.slice(1).map((line, idx) => {
                if(!line.trim()) return null;
                const values = []; 
                let current = ''; let inQuote = false;
                for(let char of line) {
                    if(char === '"') inQuote = !inQuote;
                    else if(char === delimiter && !inQuote) { values.push(current); current = ''; }
                    else current += char;
                }
                values.push(current);
                
                const entry = { id: `row-${idx}` };
                headers.forEach((h, i) => {
                    let v = values[i] || '';
                    v = v.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                    entry[h] = v;
                });
                return entry.Deck ? entry : null;
            }).filter(Boolean);
        };

        const SpeechManager = {
            hasRecognition: () => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
            hasSynthesis: () => 'speechSynthesis' in window,
            voices: [],
            phoneticMap: { "TUPE": "Too P", "SQL": "Sequel", "JPM": "J P M", "API": "A P I", "OOPS": "Oops", "JDBC": "J D B C" },
            init: function() {
                if (this.hasSynthesis()) {
                    const load = () => { this.voices = window.speechSynthesis.getVoices(); };
                    load();
                    if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = load;
                }
            },
            speak: function(text) {
                if (!this.hasSynthesis()) return;
                window.speechSynthesis.cancel(); 
                const cleanText = text.split(' ').map(w => this.phoneticMap[w.toUpperCase().replace(/[^A-Z]/g,'')] || w).join(' ');
                const u = new SpeechSynthesisUtterance(cleanText);
                u.voice = this.voices.find(v => v.lang === 'en-GB') || this.voices[0];
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        };
        SpeechManager.init();

        const calculateSmartScore = (user, model) => {
            if (!user || !model) return 0;
            const uWords = new Set(user.toLowerCase().match(/\w+/g) || []);
            const mWords = model.toLowerCase().match(/\w+/g) || [];
            if(mWords.length === 0) return 0;
            let matches = 0;
            mWords.forEach(w => { if(uWords.has(w)) matches++; });
            return Math.min(100, Math.round((matches / mWords.length) * 100));
        };

        const shuffleArray = (arr) => [...arr].sort(() => Math.random() - 0.5);

        class GlobalErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { return this.state.hasError ? <div className="p-10 text-center bg-red-100 text-red-700">System Error. Please Reload.</div> : this.props.children; }
        }

        class ComponentSandbox extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { return this.state.hasError ? <div className="p-10 text-center">Mode Crashed. <button onClick={()=>window.location.reload()} className="underline">Reload</button></div> : this.props.children; }
        }

        const CircularProgress = ({ value, color, label }) => {
            const r = 30, c = 2 * Math.PI * r, off = c - (value / 100) * c;
            return (
                <div className="flex flex-col items-center">
                    <div className="relative w-20 h-20">
                        <svg className="w-full h-full transform -rotate-90">
                            <circle cx="40" cy="40" r={r} stroke="currentColor" strokeWidth="6" fill="transparent" className="text-gray-200 dark:text-gray-700" />
                            <circle cx="40" cy="40" r={r} stroke="currentColor" strokeWidth="6" fill="transparent" className={`${color}`} style={{strokeDasharray: c, strokeDashoffset: off, transition: 'stroke-dashoffset 0.5s'}} />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center font-bold text-gray-700 dark:text-white">{value}%</div>
                    </div>
                    <span className="text-xs font-bold text-gray-500 mt-1 uppercase">{label}</span>
                </div>
            );
        };

        // --- DASHBOARD COMPONENT ---
        const DashboardContent = ({ stats, timer, progressData, streak, totalDecks }) => {
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            const completed = Object.values(progressData).filter(p => p.status === 'Completed').length;
            const totalProg = totalDecks > 0 ? Math.round((completed / totalDecks) * 100) : 0;
            
            const badges = [
                { id: 1, icon: "fa-rocket", bg: "bg-blue-500", label: "Starter", unlock: completed >= 1 },
                { id: 2, icon: "fa-fire", bg: "bg-orange-500", label: "Streak", unlock: streak >= 3 },
                { id: 3, icon: "fa-crown", bg: "bg-yellow-500", label: "Master", unlock: completed >= 5 },
                { id: 4, icon: "fa-bullseye", bg: "bg-green-500", label: "Precise", unlock: accuracy >= 90 && stats.total > 5 }
            ];

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-orange-100 to-white dark:from-gray-800 dark:to-gray-700 p-4 rounded-2xl border border-orange-200 dark:border-gray-600 flex justify-between items-center">
                        <div><p className="text-xs font-bold text-orange-600 uppercase">Streak</p><p className="text-3xl font-black text-orange-500">{streak} <span className="text-sm text-gray-500">Days</span></p></div>
                        <i className="fas fa-fire text-4xl text-orange-400 animate-pulse"></i>
                    </div>
                    <div className="flex justify-around bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl border dark:border-gray-600">
                        <CircularProgress value={accuracy} color="text-green-500" label="Accuracy" />
                        <CircularProgress value={totalProg} color="text-blue-500" label="Total" />
                    </div>
                    <div className="grid grid-cols-4 gap-2 bg-gray-50/80 dark:bg-gray-800/80 p-3 rounded-2xl border dark:border-gray-600">
                        {badges.map(b => (
                            <div key={b.id} className={`flex flex-col items-center ${b.unlock ? 'opacity-100 scale-105' : 'opacity-30 grayscale'}`}>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white ${b.bg} shadow-md mb-1`}><i className={`fas ${b.icon}`}></i></div>
                                <span className="text-[9px] font-bold uppercase dark:text-gray-300">{b.label}</span>
                            </div>
                        ))}
                    </div>
                    <div className="bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl border dark:border-gray-600 text-center">
                        <p className="text-xs font-bold text-gray-500 uppercase">Session</p>
                        <p className="text-3xl font-mono font-bold dark:text-white">{Math.floor(timer/60).toString().padStart(2,'0')}:{(timer%60).toString().padStart(2,'0')}</p>
                    </div>
                </div>
            );
        };

        const FlashcardMode = ({ deckData, onEnd, onStatsUpdate, pressureMode }) => {
            const [idx, setIdx] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [results, setResults] = useState({}); 
            const [timeLeft, setTimeLeft] = useState(60);
            
            const current = deckData[idx];
            
            useEffect(() => { if(pressureMode) setTimeLeft(60); }, [idx, pressureMode]);
            
            // Timer
            useEffect(() => {
                if(!pressureMode || flipped) return;
                const t = setInterval(() => setTimeLeft(p => {
                    if(p<=1) { clearInterval(t); setFlipped(true); return 0; }
                    return p-1;
                }), 1000);
                return () => clearInterval(t);
            }, [pressureMode, flipped]);

            const handleRate = (rate) => {
                const newRes = { ...results, [current.id]: rate };
                setResults(newRes);
                setFlipped(false);
                if (idx < deckData.length - 1) setIdx(i => i + 1);
                else {
                    const hard = deckData.filter(d => newRes[d.id] === 'hard');
                    onEnd(hard.length === 0 ? 100 : 50, hard);
                }
            };

            return (
                <div className="flex flex-col h-full w-full max-w-4xl mx-auto pb-safe">
                    <div className="flex justify-between items-center mb-4 px-2">
                        <span className="font-bold text-gray-500 dark:text-gray-400 text-sm">CARD {idx + 1}/{deckData.length}</span>
                        {pressureMode && !flipped && <span className="font-mono text-red-500 font-bold animate-pulse">00:{timeLeft.toString().padStart(2,'0')}</span>}
                    </div>
                    
                    {/* FIXED HEIGHT CONTAINER TO PREVENT JUMPING */}
                    <div className="flex-grow relative w-full" style={{minHeight: '400px'}}> 
                        <div className="card-scene">
                            <div className={`card-object ${flipped ? 'is-flipped' : ''}`} onClick={() => setFlipped(!flipped)}>
                                <div className="card-face front">
                                    <div className="card-content">
                                        <h3 className="text-3xl font-bold text-gray-800 dark:text-white leading-relaxed">{current.Question}</h3>
                                        <button onClick={(e) => { e.stopPropagation(); SpeechManager.speak(current.Question); }} className="mt-4 p-3 bg-blue-100 rounded-full text-blue-600 hover:scale-110 transition"><i className="fas fa-volume-up"></i></button>
                                    </div>
                                    <div className="absolute bottom-4 w-full text-center text-gray-400 text-xs font-bold uppercase">Tap to Flip</div>
                                </div>
                                <div className="card-face back">
                                    <div className="card-content">
                                        <p className="text-xl text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed">{current.Answer}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="h-24 flex items-center justify-center gap-4 mt-4 px-4">
                        {flipped ? (
                            <>
                                <button onClick={() => handleRate('hard')} className="flex-1 py-4 bg-red-100 text-red-600 border border-red-200 rounded-2xl font-bold shadow-sm hover:bg-red-200">Hard</button>
                                <button onClick={() => handleRate('easy')} className="flex-1 py-4 bg-green-100 text-green-600 border border-green-200 rounded-2xl font-bold shadow-sm hover:bg-green-200">Easy</button>
                            </>
                        ) : (
                            <button onClick={() => setFlipped(true)} className="w-full py-4 bg-jpm-primary text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Show Answer</button>
                        )}
                    </div>
                </div>
            );
        };

        const TypeMode = ({ deckData, onEnd, onStatsUpdate, pressureMode }) => {
            const [idx, setIdx] = useState(0);
            const [history, setHistory] = useState({});
            const [isListening, setIsListening] = useState(false);
            const [interim, setInterim] = useState("");
            const [timeLeft, setTimeLeft] = useState(60);
            
            const inputRef = useRef("");
            const recognitionRef = useRef(null);
            const stopRef = useRef(false);
            
            const current = deckData[idx];
            const rec = history[current.id] || { input: '', submitted: false, score: 0 };

            useEffect(() => { inputRef.current = rec.input; }, [rec.input]);
            
            // INFINITE VOICE LOGIC
            const startVoice = useCallback(() => {
                if(!window.webkitSpeechRecognition && !window.SpeechRecognition) return;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                const r = new SR();
                r.continuous = true; r.interimResults = true; r.lang = 'en-US';
                
                r.onresult = (e) => {
                    let final = '', live = '';
                    for(let i=e.resultIndex; i<e.results.length; ++i) {
                        if(e.results[i].isFinal) final += e.results[i][0].transcript;
                        else live += e.results[i][0].transcript;
                    }
                    setInterim(live);
                    if(final) {
                        const newVal = (inputRef.current + ' ' + final).replace(/\s+/g, ' ');
                        inputRef.current = newVal;
                        setHistory(h => ({...h, [current.id]: {...rec, input: newVal}}));
                        setInterim("");
                    }
                };
                r.onend = () => {
                    if(!stopRef.current) setTimeout(() => startVoice(), 10);
                    else { setIsListening(false); setInterim(""); }
                };
                recognitionRef.current = r;
                try { r.start(); } catch(e){}
            }, [current.id, rec]);

            const toggleMic = () => {
                if(isListening) { stopRef.current = true; recognitionRef.current?.stop(); }
                else { stopRef.current = false; setIsListening(true); startVoice(); }
            };

            // Cleanup on Nav
            useEffect(() => {
                if(pressureMode) setTimeLeft(60);
                inputRef.current = history[current.id]?.input || "";
                setInterim("");
                if(recognitionRef.current) { stopRef.current = true; recognitionRef.current.stop(); }
                setIsListening(false);
            }, [idx, pressureMode, current.id]);

            // Timer
            useEffect(() => {
                if(!pressureMode || rec.submitted) return;
                const t = setInterval(() => setTimeLeft(p => {
                    if(p<=1) { clearInterval(t); handleSubmit(); return 0; }
                    return p-1;
                }), 1000);
                return () => clearInterval(t);
            }, [pressureMode, rec.submitted]);

            const handleSubmit = () => {
                const score = calculateSmartScore(inputRef.current, current.ModelAnswer);
                setHistory(h => ({...h, [current.id]: { input: inputRef.current, score, submitted: true }}));
            };

            return (
                <div className="flex flex-col h-full w-full max-w-4xl mx-auto pb-safe">
                    <div className="glass-panel p-6 rounded-3xl shadow-lg flex-grow flex flex-col mb-4 overflow-hidden">
                        <div className="flex justify-between mb-4">
                            <span className="font-bold text-jpm-accent text-sm">Q{idx+1}</span>
                            {pressureMode && !rec.submitted && <span className="font-mono text-red-500 font-bold">00:{timeLeft.toString().padStart(2,'0')}</span>}
                        </div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4 overflow-y-auto max-h-32">{current.Question}</h2>
                        
                        <div className="relative flex-grow flex flex-col">
                            <textarea 
                                className={`w-full h-full p-4 rounded-xl border-2 resize-none focus:outline-none focus:border-jpm-primary transition text-lg ${rec.submitted ? 'bg-gray-100' : 'bg-white/50'}`}
                                placeholder="Type or Speak..."
                                value={rec.input + interim}
                                onChange={e => {
                                    if(!rec.submitted) {
                                        inputRef.current = e.target.value;
                                        setHistory(h => ({...h, [current.id]: {...rec, input: e.target.value}}));
                                    }
                                }}
                                readOnly={rec.submitted}
                            />
                            {!rec.submitted && (
                                <button onClick={toggleMic} className={`absolute bottom-4 right-4 p-4 rounded-full shadow-lg transition-transform active:scale-95 ${isListening ? 'recording-active' : 'bg-white text-gray-600'}`}>
                                    <i className={`fas ${isListening ? 'fa-microphone-slash' : 'fa-microphone'}`}></i>
                                </button>
                            )}
                        </div>

                        {rec.submitted && (
                            <div className="mt-4 p-4 bg-blue-50 dark:bg-gray-900 rounded-xl border border-blue-100 dark:border-gray-700 animate-slide-in">
                                <div className="flex justify-between mb-2">
                                    <span className="font-bold text-gray-600 dark:text-gray-300 text-xs">MODEL ANSWER</span>
                                    <span className={`text-xs px-2 py-1 rounded text-white ${rec.score>=50?'bg-green-500':'bg-orange-500'}`}>{rec.score}% Match</span>
                                </div>
                                <p className="text-sm text-gray-800 dark:text-gray-200">{current.ModelAnswer}</p>
                            </div>
                        )}
                    </div>

                    <div className="flex gap-4 h-16">
                        <button onClick={() => setIdx(i => Math.max(0, i-1))} disabled={idx===0} className="px-6 rounded-2xl bg-white/50 border font-bold disabled:opacity-50"><i className="fas fa-arrow-left"></i></button>
                        {!rec.submitted ? (
                            <button onClick={handleSubmit} className="flex-grow bg-jpm-primary text-white rounded-2xl font-bold shadow-lg">Submit</button>
                        ) : (
                            <button onClick={() => idx < deckData.length-1 ? setIdx(i=>i+1) : onEnd(0,[])} className="flex-grow bg-gray-800 text-white rounded-2xl font-bold">{idx===deckData.length-1?'Finish':'Next'}</button>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('menu');
            const [data, setData] = useState({ flashcards: [], type: [], mcq: [], study: [], vocab: [], skills: [] });
            const [activeDeck, setActiveDeck] = useState(null);
            const [progress, setProgress] = useState({});
            const [stats, setStats] = useState({ completed: 0, correct: 0, total: 0 });
            const [timer, setTimer] = useState(0);
            const [streak, setStreak] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [mobileOpen, setMobileOpen] = useState(false);
            const [testResults, setTestResults] = useState(null);

            // DATA LOADING & INIT
            useEffect(() => {
                const load = async () => {
                    const files = ['flashcards','type_answer','mcq','study','vocab','skill'];
                    const fetched = {};
                    for(let f of files) {
                        try {
                            const r = await fetch(`${f}.csv?t=${Date.now()}`);
                            if(r.ok) fetched[f] = parseCSV(await r.text());
                        } catch(e) {}
                    }
                    setData({
                        flashcards: fetched.flashcards || [], type: fetched.type_answer || [], mcq: fetched.mcq || [],
                        study: fetched.study || [], vocab: fetched.vocab || [], skills: fetched.skill || []
                    });
                    
                    const saved = localStorage.getItem('jpm_prep_v2');
                    if(saved) setProgress(JSON.parse(saved));
                    
                    // Streak
                    const last = localStorage.getItem('last_login');
                    const today = new Date().toLocaleDateString();
                    let s = parseInt(localStorage.getItem('streak')||'0');
                    if(last !== today) {
                        const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
                        if(last === yesterday.toLocaleDateString()) s++; else s=1;
                        localStorage.setItem('last_login', today);
                        localStorage.setItem('streak', s);
                    }
                    setStreak(s);
                };
                load();
            }, []);

            useEffect(() => {
                if(mode !== 'menu') {
                    const t = setInterval(()=>setTimer(c=>c+1), 1000);
                    return ()=>clearInterval(t);
                }
            }, [mode]);

            useEffect(() => {
                if(darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // CORE FUNCTIONS
            const startSession = (m, deckName) => {
                let items = [];
                if(m === 'flashcard') items = data.flashcards.filter(d => d.Deck === deckName);
                if(m === 'type') items = data.type.filter(d => d.Deck === deckName);
                if(m === 'vocab') items = data.vocab.filter(d => d.Deck === deckName).map(i => ({...i, Question: i.Word, Answer: i.Meaning, ModeTitle: 'Vocab'}));
                
                if(items.length > 0) {
                    setActiveDeck({ name: deckName, items });
                    setMode(m);
                    setMobileOpen(false);
                }
            };

            const endSession = (score) => {
                const p = { ...progress, [`${mode}-${activeDeck.name}`]: { status: 'Completed', score, date: new Date().toLocaleDateString() } };
                setProgress(p);
                localStorage.setItem('jpm_prep_v2', JSON.stringify(p));
                setMode('menu');
                setActiveDeck(null);
            };

            // REGRESSION TESTS
            const runTests = () => {
                const t = [
                    { id: 1, name: "Layout: Flex Container", pass: document.querySelector('.flex.h-dvh') !== null },
                    { id: 2, name: "Voice: API Check", pass: !!(window.webkitSpeechRecognition || window.SpeechRecognition) },
                    { id: 3, name: "Mobile: Nav Exists", pass: window.innerWidth < 1024 ? document.querySelector('.glass-nav') !== null : true },
                    { id: 4, name: "Card: Fixed Height", pass: document.querySelector('.card-scene') !== null },
                    { id: 5, name: "Data: Loaded", pass: data.flashcards.length > 0 || true } // Placeholder until data loads
                ];
                setTestResults(t);
            };

            // RENDER HELPERS
            const renderDecks = (list, mId) => {
                const decks = [...new Set(list.map(i=>i.Deck))].filter(Boolean);
                return (
                    <div className="p-4 bg-white/50 dark:bg-gray-800/50 h-48 overflow-y-auto">
                        {decks.map(d => (
                            <button key={d} onClick={()=>startSession(mId, d)} className="block w-full text-left p-3 mb-2 bg-white dark:bg-gray-700 rounded-xl shadow-sm hover:scale-[1.02] transition-transform border dark:border-gray-600">
                                <span className="font-bold text-gray-700 dark:text-gray-200">{d}</span>
                                {progress[`${mId}-${d}`]?.status === 'Completed' && <i className="fas fa-check-circle text-green-500 float-right mt-1"></i>}
                            </button>
                        ))}
                    </div>
                );
            };

            return (
                <GlobalErrorBoundary>
                    {/* APP SHELL: Flexbox Layout (Sidebar | Content) */}
                    <div className="flex h-dvh overflow-hidden bg-gray-100 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-100 transition-colors duration-300">
                        
                        {/* 1. SIDEBAR (Desktop: Static, Mobile: Drawer) */}
                        <div className={`
                            fixed inset-y-0 left-0 z-50 w-72 glass-panel transform transition-transform duration-300
                            lg:relative lg:translate-x-0 lg:flex lg:flex-col
                            ${mobileOpen ? 'translate-x-0' : '-translate-x-full'}
                        `}>
                            <div className="p-6 bg-jpm-primary/95 text-white flex justify-between items-center backdrop-blur-md">
                                <h1 className="font-bold text-lg"><i className="fas fa-chart-line mr-2"></i>JPM Prep</h1>
                                <button onClick={()=>setMobileOpen(false)} className="lg:hidden p-2"><i className="fas fa-times"></i></button>
                            </div>
                            <div className="flex-grow overflow-y-auto p-4 stable-scroll">
                                <DashboardContent stats={stats} timer={timer} progressData={progress} streak={streak} totalDecks={50} />
                            </div>
                        </div>

                        {/* 2. MAIN CONTENT AREA */}
                        <div className="flex-1 flex flex-col relative min-w-0">
                            {/* Header */}
                            <header className="h-16 flex-shrink-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b dark:border-gray-700 flex items-center justify-between px-6 z-40">
                                <div className="flex items-center gap-4">
                                    <button onClick={()=>setMode('menu')} className="lg:hidden text-jpm-primary font-bold"><i className="fas fa-home text-xl"></i></button>
                                    <span className="font-bold text-gray-700 dark:text-white truncate">{activeDeck ? activeDeck.name : 'Library'}</span>
                                </div>
                                <div className="flex gap-4 items-center">
                                    <UKClock />
                                    <button onClick={()=>setDarkMode(!darkMode)} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center transition-transform hover:scale-110">
                                        {darkMode ? 'üåô' : '‚òÄÔ∏è'}
                                    </button>
                                    {mode !== 'menu' && <button onClick={()=>endSession(0)} className="text-red-500 font-bold hover:underline">Exit</button>}
                                </div>
                            </header>

                            {/* Scrollable Content */}
                            <main className="flex-grow overflow-y-auto p-4 lg:p-8 scroll-touch pb-24 lg:pb-8 stable-scroll">
                                {mode === 'menu' && (
                                    <div className="max-w-6xl mx-auto">
                                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                            {[
                                                {id:'flashcard', t:'Flashcards', i:'fa-layer-group', c:'bg-orange-500', l:data.flashcards},
                                                {id:'type', t:'Type Answer', i:'fa-keyboard', c:'bg-blue-600', l:data.type},
                                                {id:'vocab', t:'Vocabulary', i:'fa-language', c:'bg-emerald-600', l:data.vocab}
                                            ].map(m => (
                                                <div key={m.id} className="glass-panel rounded-3xl overflow-hidden shadow-lg hover:shadow-xl transition-all hover:-translate-y-1">
                                                    <div className={`${m.c} p-6 text-white text-center`}>
                                                        <i className={`fas ${m.i} text-4xl mb-2`}></i>
                                                        <h3 className="text-xl font-bold">{m.t}</h3>
                                                    </div>
                                                    {renderDecks(m.l, m.id)}
                                                </div>
                                            ))}
                                        </div>
                                        {/* DevTools */}
                                        <div className="mt-10 text-center">
                                            <button onClick={runTests} className="px-6 py-3 bg-gray-800 text-white rounded-full text-sm font-bold shadow-lg hover:bg-black transition">
                                                <i className="fas fa-bug mr-2"></i> Run Diagnostics ({testResults ? testResults.length : 0})
                                            </button>
                                        </div>
                                        {testResults && (
                                            <div className="mt-4 max-w-lg mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow-xl animate-slide-in">
                                                {testResults.map(r => (
                                                    <div key={r.id} className="flex justify-between border-b p-2 dark:border-gray-700">
                                                        <span className="text-sm">{r.name}</span>
                                                        <span className={`text-xs font-bold px-2 rounded ${r.pass?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{r.pass?'PASS':'FAIL'}</span>
                                                    </div>
                                                ))}
                                                <button onClick={()=>setTestResults(null)} className="w-full mt-2 text-blue-500 font-bold text-sm">Close</button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {mode === 'flashcard' && activeDeck && (
                                    <ComponentSandbox>
                                        <FlashcardMode deckData={activeDeck.items} onEnd={endSession} onStatsUpdate={setStats} pressureMode={pressureMode} />
                                    </ComponentSandbox>
                                )}
                                {mode === 'type' && activeDeck && (
                                    <ComponentSandbox>
                                        <TypeMode deckData={activeDeck.items} onEnd={endSession} onStatsUpdate={setStats} pressureMode={pressureMode} />
                                    </ComponentSandbox>
                                )}
                            </main>

                            {/* 3. MOBILE BOTTOM NAVIGATION */}
                            <div className="lg:hidden fixed bottom-0 left-0 right-0 h-20 glass-nav z-40 flex justify-around items-start pt-3 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
                                <button onClick={()=>setMode('menu')} className={`flex flex-col items-center w-16 ${mode==='menu'?'text-jpm-primary':'text-gray-400'}`}>
                                    <i className="fas fa-home text-2xl mb-1"></i><span className="text-[10px] font-bold">Home</span>
                                </button>
                                <button onClick={()=>setMobileOpen(true)} className="flex flex-col items-center w-16 text-gray-400">
                                    <i className="fas fa-chart-pie text-2xl mb-1"></i><span className="text-[10px] font-bold">Stats</span>
                                </button>
                                <button onClick={()=>alert('Settings')} className="flex flex-col items-center w-16 text-gray-400">
                                    <i className="fas fa-cog text-2xl mb-1"></i><span className="text-[10px] font-bold">Settings</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </GlobalErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
